"use strict";var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i["return"]&&_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();angular.module("ui.mention",[]).directive("uiMention",function(){return{require:["ngModel","uiMention"],controller:"uiMention",controllerAs:"$mention",link:function($scope,$element,$attrs,_ref){var _ref2=_slicedToArray(_ref,2),ngModel=_ref2[0],uiMention=_ref2[1];uiMention.init(ngModel)}}}),angular.module("ui.mention").controller("uiMention",["$element","$scope","$attrs","$q","$timeout","$document","$compile",function($element,$scope,$attrs,$q,$timeout,$document,$compile){function parseContentAsText(content){try{return temp.textContent=content,temp.innerHTML}finally{temp.textContent=null}}function getTextBoundingRect(input,selectionStart,selectionEnd,debug){function appendPart(start,end){var span=document.createElement("span"),tmpText=text.substring(start,end);return span.style.cssText=cssDefaultStyles,/[\n\r]$/.test(tmpText)&&(tmpText+=" "),span.textContent=tmpText,fakeClone.appendChild(span),span}function getInputOffset(){var body=document.body,win=document.defaultView,docElem=document.documentElement,box=document.createElement("div");box.style.paddingLeft=box.style.width="1px",body.appendChild(box);var isBoxModel=2==box.offsetWidth;body.removeChild(box),box=input.getBoundingClientRect();var clientTop=docElem.clientTop||body.clientTop||0,clientLeft=docElem.clientLeft||body.clientLeft||0,scrollTop=win.pageYOffset||isBoxModel&&docElem.scrollTop||body.scrollTop,scrollLeft=win.pageXOffset||isBoxModel&&docElem.scrollLeft||body.scrollLeft;return{top:box.top+scrollTop-clientTop,left:box.left+scrollLeft-clientLeft}}function getInputCSS(prop,isnumber){var val=document.defaultView.getComputedStyle(input,null).getPropertyValue(prop);return isnumber?parseFloat(val):val}if(!(input&&"value"in input))return input;if("string"==typeof selectionStart&&(selectionStart=parseFloat(selectionStart)),("number"!=typeof selectionStart||isNaN(selectionStart))&&(selectionStart=0),selectionStart=selectionStart<0?0:Math.min(input.value.length,selectionStart),"string"==typeof selectionEnd&&(selectionEnd=parseFloat(selectionEnd)),("number"!=typeof selectionEnd||isNaN(selectionEnd)||selectionEnd<selectionStart)&&(selectionEnd=selectionStart),selectionEnd=selectionEnd<0?0:Math.min(input.value.length,selectionEnd),"function"==typeof input.createTextRange){var range=input.createTextRange();return range.collapse(!0),range.moveStart("character",selectionStart),range.moveEnd("character",selectionEnd-selectionStart),range.getBoundingClientRect()}var offset=getInputOffset(),topPos=offset.top,leftPos=offset.left,width=getInputCSS("width",!0),height=getInputCSS("height",!0),cssDefaultStyles="white-space:pre-wrap;padding:0;margin:0;",text=input.value,textLen=text.length,fakeClone=document.createElement("div");selectionStart>0&&appendPart(0,selectionStart);var fakeRange=appendPart(selectionStart,selectionEnd);textLen>selectionEnd&&appendPart(selectionEnd,textLen),fakeClone.style.cssText=cssDefaultStyles,fakeClone.style.position="absolute",fakeClone.style.top=topPos+"px",fakeClone.style.left=leftPos+"px",fakeClone.style.width=width+"px",fakeClone.style.height=height+"px",document.body.appendChild(fakeClone);var returnValue=fakeRange.getBoundingClientRect();return debug||fakeClone.parentNode.removeChild(fakeClone),returnValue}function appendTemplate(choices,_this,coordinates){var html='<ul class="dropdown">      <li ng-repeat="choice in $mention.choices" ng-class="{active:$mention.activeChoice==choice}">        <a ng-click="$mention.select(choice)">          {{choice.label}}        </a>      </li>    </ul>',element=angular.element(html);element.css({display:"block",visibility:"visible",left:coordinates.left+"px",top:coordinates.top+"px",width:0}),angular.element($document[0].querySelector(".mention-container")).append(element),_this.$compile(element)(_this.$scope)}function updatePopOverPosition(element){var coordinates=getTextBoundingRect(element,element.selectionStart,element.selectionEnd,!1);angular.element($document[0].querySelector(".dropdown")).css({left:coordinates.left+"px",top:coordinates.top+"px"})}var _this3=this;this.delimiter="$",this.searchPattern=this.pattern||new RegExp("(?:\\s+|^)\\"+this.delimiter+"([A-Za-z0-9._-]*(?: \\w+)?)$"),this.decodePattern=new RegExp(this.delimiter+"[[\\s\\w]+:[0-9a-z-]+]","gi"),this.$element=$element,this.$compile=$compile,this.$scope=$scope,this.$attrs=$attrs,this.choices=[],this.mentions=[];var ngModel;this.init=function(model){var _this2=this;$attrs.ngTrim="false",ngModel=model,ngModel.$parsers.push(function(value){return _this2.mentions=_this2.mentions.filter(function(mention){if(~value.indexOf(_this2.label(mention)))return value=value.replace(_this2.label(mention),_this2.encode(mention))}),_this2.render(value),value}),ngModel.$formatters.push(function(){var value=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return value=value.toString(),_this2.mentions=_this2.mentions.filter(function(mention){return!!~value.indexOf(_this2.encode(mention))&&(value=value.replace(_this2.encode(mention),_this2.label(mention)),!0)}),value}),ngModel.$render=function(){$element.val(ngModel.$viewValue||""),$timeout(_this2.autogrow,!0),_this2.render()},appendTemplate(this.choices,this,getTextBoundingRect($element[0],$element[0].selectionStart,$element[0].selectionEnd,!1))};var temp=document.createElement("span");this.render=function(){var html=arguments.length<=0||void 0===arguments[0]?ngModel.$modelValue:arguments[0];return html=(html||"").toString(),html=parseContentAsText(html),_this3.mentions.forEach(function(mention){html=html.replace(_this3.encode(mention),_this3.highlight(mention))}),_this3.renderElement().html(html),html},this.renderElement=function(){return $element.next()},this.highlight=function(choice){return""+this.label(choice)},this.decode=function(){var value=arguments.length<=0||void 0===arguments[0]?ngModel.$modelValue:arguments[0];return value?value.replace(this.decodePattern,"$1"):""},this.label=function(choice){return""+this.delimiter+choice.label},this.encode=function(choice){return""+this.delimiter+this.label(choice)},this.replace=function(mention){var search=arguments.length<=1||void 0===arguments[1]?this.searching:arguments[1],text=arguments.length<=2||void 0===arguments[2]?ngModel.$viewValue:arguments[2];return text=text.substr(0,search.index+search[0].indexOf(this.delimiter))+this.label(mention)+text.substr(search.index+search[0].length)},this.select=function(){var choice=arguments.length<=0||void 0===arguments[0]?this.activeChoice:arguments[0];return!!choice&&(this.mentions.push(choice),ngModel.$setViewValue(this.replace(choice)),this.cancel(),void ngModel.$render())},this.up=function(){var index=this.choices.indexOf(this.activeChoice);index>0?this.activeChoice=this.choices[index-1]:this.activeChoice=this.choices[this.choices.length-1]},this.down=function(){var index=this.choices.indexOf(this.activeChoice);index<this.choices.length-1?this.activeChoice=this.choices[index+1]:this.activeChoice=this.choices[0]},this.search=function(match){var _this4=this;return this.searching=match,$q.when(this.findChoices(match,this.mentions)).then(function(choices){return _this4.choices=choices,_this4.activeChoice=choices[0],choices})},this.findChoices=function(match,mentions){return[]},this.cancel=function(){this.choices=[],this.searching=null},this.autogrow=function(){$element[0].style.height=0;var style=getComputedStyle($element[0]);"border-box"==style.boxSizing&&($element[0].style.height=$element[0].scrollHeight+"px")},$element.on("keyup",function(event){if(_this3.moved)return _this3.moved=!1;if($element[0].selectionStart==$element[0].selectionEnd){var text=$element.val(),match=_this3.searchPattern.exec(text.substr(0,$element[0].selectionStart));match?(_this3.search(match),updatePopOverPosition($element[0])):_this3.cancel(),$scope.$$phase||$scope.$apply()}}),$element.on("keydown",function(event){if(_this3.searching){switch(event.keyCode){case 13:_this3.select();break;case 38:_this3.up();break;case 40:_this3.down();break;default:return}_this3.moved=!0,event.preventDefault(),$scope.$$phase||$scope.$apply()}}),this.onMouseup=function(event){var _this5=this;event.target!=$element[0]&&($document.off("mouseup",this.onMouseup),this.searching&&$scope.$evalAsync(function(){_this5.cancel()}))}.bind(this),$element.on("focus",function(event){$document.on("mouseup",_this3.onMouseup)}),$element.on("input",this.autogrow),$timeout(this.autogrow,!0)}]);